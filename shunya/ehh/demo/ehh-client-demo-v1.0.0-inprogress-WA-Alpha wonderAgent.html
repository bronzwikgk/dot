<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ActionApp v1 Demo</title>
  <style>
    :root {
      font-family: 'Segoe UI', system-ui, sans-serif;
      color: #101828;
      background-color: #f7f7f5;
    }
    body {
      margin: 0;
      padding: 0;
      background: #f7f7f5;
    }
    main {
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
      max-width: 960px;
      margin: 0 auto;
      padding: 1.5rem;
    }
    section {
      border-radius: 0.75rem;
      border: 1px solid #d0d5dd;
      background: #ffffff;
      padding: 1.25rem;
      box-shadow: 0 8px 24px -12px rgba(15, 23, 42, 0.25);
    }
    h1,
    h2 {
      margin-top: 0;
    }
    form {
      display: grid;
      gap: 0.75rem;
    }
    label {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      font-size: 0.95rem;
    }
    input,
    select,
    button {
      padding: 0.45rem 0.65rem;
      border-radius: 0.4rem;
      border: 1px solid #c1c7d0;
      font-size: 0.95rem;
      font-family: inherit;
    }
    button {
      cursor: pointer;
      background: #0f62fe;
      color: #fff;
      border: none;
      transition: background 0.2s ease;
    }
    button:hover {
      background: #0353e9;
    }
    #demo-log {
      min-height: 150px;
      background: #05090f;
      color: #b8f1d7;
      font-family: 'Consolas', 'Courier New', monospace;
      padding: 1rem;
      border-radius: 0.5rem;
      overflow: auto;
      white-space: pre-wrap;
    }
    .button-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.5rem;
      margin-top: 0.75rem;
    }
    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }
  </style>
</head>
<body>
  <main>
    <h1>ActionApp v1 API Demo</h1>
    <section id="automation">
      <h2>Automated Test Matrix</h2>
      <p>
        Each button executes multiple data variations across actions and roles. Logs include request/response pairs
        plus storage snapshots, so you can validate action/entity/role permutations.
      </p>
      <div class="button-grid">
        <button id="act-localstorage" type="button">Batch LocalStorage Tests</button>
        <button id="act-indexeddb" type="button">Batch IndexedDB Tests</button>
        <button id="act-backend" type="button">Batch Backend Tests</button>
        <button id="run-all" type="button">Run All Tests</button>
      </div>
    </section>
    <section id="test-controls">
      <h2>Diagnostics Tests</h2>
      <p>
        Trigger localStorage checks, IndexedDB routines, backend integration, or run every test in sequence. Logs
        appear below with copy support.
      </p>
      <div class="button-grid">
        <button id="test-localstorage" type="button">Test LocalStorage</button>
        <button id="test-indexeddb" type="button">Test IndexedDB</button>
        <button id="test-backend" type="button">Test Backend</button>
        <button id="run-all" type="button">Run All Tests</button>
        <button id="copy-log" type="button">Copy Logs</button>
      </div>
    </section>
    <section>
      <h2>Logs</h2>
      <div id="demo-log" aria-live="polite"></div>
    </section>
  </main>
  <script type="module">
    import { ActionClient, ActionEvent } from './ehh-action-client.mjs';

    const client = new ActionClient('http://localhost:4173');
    const events = new ActionEvent();
    const logElement = document.getElementById('demo-log');
    const logHistory = [];

    function appendLog(message) {
      const timestamp = new Date().toISOString();
      const entry = `${timestamp} - ${message}`;
      logHistory.push(entry);
      logElement.textContent = logHistory.join('\n');
      logElement.scrollTop = logElement.scrollHeight;
      console.log(entry);
    }

    const roles = ['guest', 'user', 'manager', 'admin'];
    const actions = ['createUser', 'createSession', 'batchReport'];

    async function runBackendAction(role, action) {
      const base = {
        username: `${role}-${Date.now()}`,
        email: `${role}-${Date.now()}@example.com`,
        password: 'Passw0rd!',
        role
      };
      try {
        if (action === 'createUser') {
          const result = await client.createUser(base);
          appendLog(`backend ${action} [${role}] → ${JSON.stringify(result)}`);
          return result.data && result.data._id;
        }
        if (action === 'createSession') {
          const result = await client.createSession({
            username: base.username,
            role,
            sessionId: `sess-${Date.now()}`,
            appToken: `token-${Date.now()}`,
            createdAt: new Date().toISOString(),
            expiresAt: new Date(Date.now() + 600000).toISOString(),
            status: 'active'
          });
          appendLog(`backend ${action} [${role}] → ${JSON.stringify(result)}`);
          return result.data && result.data.sessionId;
        }
        if (action === 'batchReport') {
          const report = await client.request('/api/v1/test/batch', 'GET');
          appendLog(`backend ${action} [${role}] → ${JSON.stringify(report)}`);
          return report;
        }
      } catch (error) {
        appendLog(`backend ${action} [${role}] failed: ${error.message || error}`);
      }
      return null;
    }

    async function testLocalStorage() {
      try {
        window.localStorage.setItem('ehh:v1:user', JSON.stringify({ id: `user-${Date.now()}`, role: 'tester' }));
        const value = window.localStorage.getItem('ehh:v1:user');
        window.localStorage.removeItem('ehh:v1:user');
        appendLog(`LocalStorage test passed (snapshot: ${value})`);
      } catch (error) {
        appendLog(`LocalStorage test failed: ${error.message}`);
      }
    }

    function openDemoDb() {
      return new Promise((resolve, reject) => {
        const request = window.indexedDB.open('ehh-demo-v1', 1);
        request.onupgradeneeded = function () {
          const db = request.result;
          if (!db.objectStoreNames.contains('records')) {
            db.createObjectStore('records', { keyPath: 'id' });
          }
        };
        request.onsuccess = function () {
          resolve(request.result);
        };
        request.onerror = function () {
          reject(request.error);
        };
      });
    }

    async function testIndexedDb() {
      if (!window.indexedDB) {
        appendLog('IndexedDB unavailable in this environment.');
        return;
      }
      try {
        const db = await openDemoDb();
        const tx = db.transaction('records', 'readwrite');
        const store = tx.objectStore('records');
        const payload = { id: `rec-${Date.now()}`, value: 'demo' };
        store.put(payload);
        await new Promise((resolve, reject) => {
          tx.oncomplete = resolve;
          tx.onerror = () => reject(tx.error);
        });
        const readTx = db.transaction('records', 'readonly');
        const readStore = readTx.objectStore('records');
        const request = readStore.get(payload.id);
        request.onsuccess = function () {
          appendLog(`IndexedDB stored and read ${JSON.stringify(request.result)}`);
          db.close();
        };
      } catch (error) {
        appendLog(`IndexedDB test failed: ${error.message}`);
      }
    }

    async function testBackend() {
      try {
        const sample = {
          username: `demo-${Date.now()}`,
          email: `demo-${Date.now()}@example.com`,
          password: 'Passw0rd!',
          role: 'admin'
        };
        const userResponse = await client.createUser(sample);
        appendLog(`Backend createUser → ${JSON.stringify(userResponse)}`);
        const sessionResponse = await client.createSession({
          username: sample.username,
          role: sample.role,
          sessionId: `sess-${Date.now()}`,
          appToken: `token-${Date.now()}`,
          createdAt: new Date().toISOString(),
          expiresAt: new Date(Date.now() + 600000).toISOString(),
          status: 'active'
        });
        appendLog(`Backend createSession → ${JSON.stringify(sessionResponse)}`);
        const batch = await client.request('/api/v1/test/batch', 'GET');
        appendLog(`Backend batch report → ${JSON.stringify(batch)}`);
      } catch (error) {
        appendLog(`Backend test failed: ${error.message || error}`);
      }
    }

    async function batchLocalStorage() {
      for (let i = 0; i < roles.length; i += 1) {
        await testLocalStorage();
      }
    }

    async function batchIndexedDb() {
      for (let i = 0; i < roles.length; i += 1) {
        await testIndexedDb();
      }
    }

    async function batchBackend() {
      for (let i = 0; i < roles.length; i += 1) {
        for (let j = 0; j < actions.length; j += 1) {
          await runBackendAction(roles[i], actions[j]);
        }
      }
    }

    async function runAllTests() {
      await batchLocalStorage();
      await batchIndexedDb();
      await batchBackend();
    }

    events.add(document.getElementById('act-localstorage'), 'click', batchLocalStorage);
    events.add(document.getElementById('act-indexeddb'), 'click', batchIndexedDb);
    events.add(document.getElementById('act-backend'), 'click', batchBackend);
    events.add(document.getElementById('run-all'), 'click', runAllTests);
    events.add(document.getElementById('copy-log'), 'click', async function () {
      try {
        await navigator.clipboard.writeText(logHistory.join('\n'));
        appendLog('Copied log to clipboard.');
      } catch (error) {
        appendLog(`Copy log failed: ${error.message}`);
      }
    });
  </script>
</body>
</html>
